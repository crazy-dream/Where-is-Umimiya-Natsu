<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>Clown Game with Story</title>
<style>
    body {
        margin: 0;
        background: black;
        overflow: hidden;
        user-select: none;
    }

    /* 全螢幕故事圖片 */
    #storyScreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: black;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 9999;
    }

    #storyImage {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    /* 點擊提示文字 */
    #clickHint {
        position: fixed;
        right: 20px;
        bottom: 20px;
        font-size: 28px;
        font-weight: bold;
        writing-mode: vertical-rl;
        color: black; /* 開場預設黑色字 */
    }

    /* 遊戲畫布 */
    #gameCanvas {
        display: none;
        background: #222;
    }
</style>
</head>
<body>

<!-- 故事播放畫面 -->
<div id="storyScreen">
    <img id="storyImage">
    <div id="clickHint">點擊任意地方繼續</div>
</div>

<!-- 遊戲畫布 -->
<canvas id="gameCanvas" width="800" height="600"></canvas>

<script>
// --------------------------------------------------------------
//  故事播放系統
// --------------------------------------------------------------

const storyScreen = document.getElementById("storyScreen");
const storyImage = document.getElementById("storyImage");
const clickHint = document.getElementById("clickHint");
const gameCanvas = document.getElementById("gameCanvas");

let storyList = [];
let storyIndex = 0;
let storyCallback = null;

/* 播放圖片序列 */
function playStory(images, lastTextWhite, callback) {
    storyList = images;
    storyIndex = 0;
    storyCallback = callback;

    storyScreen.style.display = "flex";
    gameCanvas.style.display = "none";

    showStoryImage(lastTextWhite);
}

function showStoryImage(lastTextWhite) {
    storyImage.src = storyList[storyIndex];

    // 最後一張文字換白色
    if (storyIndex === storyList.length - 1 && lastTextWhite) {
        clickHint.style.color = "white";
        clickHint.textContent = "點擊任意地方再一次";
    } else {
        clickHint.style.color = "black";
        clickHint.textContent = "點擊任意地方繼續";
    }
}

storyScreen.addEventListener("click", () => {
    storyIndex++;
    if (storyIndex >= storyList.length) {
        storyScreen.style.display = "none";
        clickHint.style.color = "black";
        if (storyCallback) storyCallback();
        return;
    }
    showStoryImage();
});

// --------------------------------------------------------------
//  開場故事（1～6）
// --------------------------------------------------------------

playStory(
    [
        "story/洋芋片1.jpg",
        "story/洋芋片2.jpg",
        "story/洋芋片3.jpg",
        "story/洋芋片4.jpg",
        "story/洋芋片5.jpg",
        "story/洋芋片6.jpg"
    ],
    false,
    startGame
);

// --------------------------------------------------------------
//  遊戲本體
// --------------------------------------------------------------

const ctx = gameCanvas.getContext("2d");

let player = { x: 400, y: 500, size: 30 };
let enemies = [];
let score = 0;
let gameOver = false;
let gameWin = false;

function startGame() {
    gameCanvas.style.display = "block";
    resetGame();
    loop();
}

function resetGame() {
    score = 0;
    gameOver = false;
    gameWin = false;
    enemies = [];

    // 生成敵人
    for (let i = 0; i < 10; i++) {
        enemies.push({
            x: Math.random() * 760,
            y: Math.random() * 300,
            size: 30,
            speed: 1 + Math.random() * 2
        });
    }
}

document.addEventListener("mousemove", (e) => {
    let rect = gameCanvas.getBoundingClientRect();
    player.x = e.clientX - rect.left;
    player.y = e.clientY - rect.top;
});

function loop() {
    if (gameOver || gameWin) return;

    ctx.clearRect(0, 0, 800, 600);

    // player
    ctx.fillStyle = "cyan";
    ctx.beginPath();
    ctx.arc(player.x, player.y, player.size, 0, Math.PI * 2);
    ctx.fill();

    // enemies
    ctx.fillStyle = "red";
    for (let e of enemies) {
        e.y += e.speed;
        ctx.beginPath();
        ctx.arc(e.x, e.y, e.size, 0, Math.PI * 2);
        ctx.fill();

        // 撞到玩家 → Game Over
        if (distance(player, e) < player.size + e.size) {
            gameOver = true;
            setTimeout(() => {
                playStory(
                    [
                        "story/洋芋片7.jpg",
                        "story/洋芋片8.jpg",
                        "story/洋芋片9.jpg"
                    ],
                    true,
                    startGame
                );
            }, 500);
        }

        // 敵人掉出畫面
        if (e.y > 600) {
            score++;
            e.y = -50;
            e.x = Math.random() * 760;

            // Win 條件
            if (score >= 10) {
                gameWin = true;
                setTimeout(() => {
                    playStory(
                        [
                            "story/洋芋片8.jpg",
                            "story/洋芋片9.jpg"
                        ],
                        true,
                        startGame
                    );
                }, 500);
            }
        }
    }

    requestAnimationFrame(loop);
}

function distance(a, b) {
    return Math.hypot(a.x - b.x, a.y - b.y);
}
</script>

</body>
</html>
